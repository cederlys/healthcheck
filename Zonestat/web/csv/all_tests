% for my $n (@data) { $csv->combine(@{$n});
<% $csv->string %>
% }
<%flags>
inherit => undef
</%flags>
<%init>
my $pres = $zs->present;
my $rs;
my @data = (['Domain name',
             'Start time',
             'Duration',
             'Critical Errors',
             'Errors',
             'Warnings',
             'Notices',
             'Info messages'
             ]);

$r->content_type('text/csv');

if (defined($sid)) {
    my $tmp = $pres->dbx('Testrun')->find($sid);
    $rs = $tmp->tests;
    $r->headers_out->add('Content-disposition' => "attachment;  filename=".$tmp->name.".csv");
} else {
    $rs = $pres->all_dnscheck_tests;
    $r->headers_out->add('Content-disposition' => "attachment;  filename=all_tests.csv");
}

foreach my $i ($rs->all) {
    push @data, [
        $i->domain,
        $i->begin(1),
        $i->end - $i->begin,
        $i->count_critical,
        $i->count_error,
        $i->count_warning,
        $i->count_notice,
        $i->count_info
    ];
}

my $csv = Text::CSV_XS->new;
</%init>
<%args>
$sid => undef
</%args>